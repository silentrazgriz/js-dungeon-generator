<!DOCTYPE HTML>
<html>
	<head>
		<link rel="stylesheet" href="default.css"/>
		<script src="leaf.js"></script>
		<script src="render.js"></script>
		<script src="room.js"></script>
		<script src="random.js"></script>
		<script src="rectangle.js"></script>
		<script src="point.js"></script>
	</head>
	<body>
		<div class="info">
			<button onclick="split()">Split!</button>
			<button onclick="refresh()">Refresh!</button>
			<div id="iter">Iteration : 0</div>
			<div id="roomCount">Room Count : 0</div>
			<div id="hallCount">Hall Count : 0</div>
		</div>
		<canvas class="map" id="canvas" width="600" height="600">
		</canvas>
		<script>
			// Main Code
			var canvas = document.getElementById('canvas');
			var render = new Render(canvas.getContext('2d'));
			var random = new Random();
			var rootLeaf;
			var leafs = new Array();
			var iter = 0;
			var maxSize = 20;
			var minSize = 10;

			// Info Component
			var iterText = document.getElementById('iter');
			var roomCountText = document.getElementById('roomCount');
			var hallCountText = document.getElementById('hallCount');

			refresh();

			// Function
			// Refresh the BSP
			function refresh() {
				rootLeaf = new Leaf(new Rectangle(0, 0, 60, 60), render.getRandomColor(), minSize);
				leafs = new Array();
				halls = new Array();
				rooms = new Array();
				leafs.push(rootLeaf);
				iter = 0;
				drawAll();
			}
			// Split current last child
			function split() {
				refresh();
				var leafsLength = 0;
				var didSplit = true;
				while(didSplit) {
					didSplit = false;
					leafsLength = leafs.length;
					for (var j = 0; j < leafsLength; j++) {
						if (leafs[j].leftNode == null && leafs[j].rightNode == null) {
							if (leafs[j].rect.width > maxSize || leafs[j].rect.height > maxSize) {
								if (leafs[j].split()) {
									leafs.push(leafs[j].leftNode);
									leafs.push(leafs[j].rightNode);
									didSplit = true;
								}
							}
						}
					}
					iter++;
				}
				rootLeaf.createRoom();
				drawAll();
			}
			// Draw all child
			function drawAll() {
				var roomCount = 0;
				var hallCount = 0;
				render.clear(canvas);
				// draw leaf & room
				for (var i = 0; i < leafs.length; i++) {
					if (leafs[i].leftNode == null && leafs[i].rightNode == null) {
						// draw leaf
						leafs[i].draw();
						if (leafs[i].room != null) {
							// draw room
							leafs[i].room.draw();
							roomCount++;
						}
					}
				}
				// draw hall
				for (var i = 0; i < leafs.length; i++) {
					var hallLength = leafs[i].halls.length;
					if (hallLength > 0) {
						for (var j = 0; j < hallLength; j++) {
							leafs[i].halls[j].draw();
							hallCount++;
						}
					}
				}
				iterText.innerHTML = "Iteration : " + iter;
				roomCountText.innerHTML = "Room Count : " + roomCount;
				hallCountText.innerHTML = "Hall Count : " + hallCount;
			}
		</script>
	</body>
</html>
